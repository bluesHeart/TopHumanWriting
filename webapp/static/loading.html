<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <title>TopHumanWriting 正在启动…</title>
    <style>
      :root {
        --bg: #f8f9fa;
        --card: #ffffff;
        --text: #212529;
        --muted: #6c757d;
        --border: #dee2e6;
        --accent: #14b8a6;
        --accent2: #2f80ed;
        --shadow: 0 18px 45px rgba(0, 0, 0, 0.08);
        --radius: 16px;
        --font: "Microsoft YaHei UI", "Segoe UI", system-ui, -apple-system, sans-serif;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #1a1a1a;
          --card: #242424;
          --text: #e4e4e4;
          --muted: #a8a8a8;
          --border: #3a3a3a;
          --shadow: 0 18px 45px rgba(0, 0, 0, 0.35);
        }
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: var(--font);
        background: radial-gradient(900px 420px at 18% 20%, rgba(20, 184, 166, 0.12), transparent 60%),
          radial-gradient(820px 420px at 84% 20%, rgba(47, 128, 237, 0.12), transparent 58%), var(--bg);
        color: var(--text);
        display: grid;
        place-items: center;
        padding: 18px;
      }
      .card {
        width: min(720px, 100%);
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 20px 22px;
      }
      .brand {
        display: flex;
        gap: 14px;
        align-items: center;
        margin-bottom: 14px;
      }
      .mark {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        display: grid;
        place-items: center;
        color: #fff;
        font-weight: 800;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
      }
      .title {
        font-weight: 800;
        letter-spacing: 0.2px;
      }
      .sub {
        margin-top: 2px;
        color: var(--muted);
        font-size: 12px;
      }
      .row {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
        align-items: baseline;
      }
      .status {
        font-size: 13px;
        color: var(--muted);
        line-height: 1.6;
      }
      .hint {
        font-size: 12px;
        color: var(--muted);
      }
      .bar {
        margin-top: 14px;
        height: 12px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.06);
        overflow: hidden;
        border: 1px solid var(--border);
      }
      .bar > div {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--accent), var(--accent2));
        transition: width 220ms ease-out;
      }
      .small {
        margin-top: 10px;
        font-size: 12px;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Cascadia Code", monospace;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="brand">
        <div class="mark" aria-hidden="true">T</div>
        <div>
          <div class="title">TopHumanWriting 正在启动…</div>
          <div class="sub">本地：范文对照检索 + 白箱润色（生成改写需要大模型）</div>
        </div>
      </div>

      <div class="row">
        <div class="status" id="statusText">准备连接本地服务…</div>
        <div class="hint mono" id="addrText">—</div>
      </div>

      <div class="bar" aria-label="启动进度">
        <div id="barInner"></div>
      </div>
      <div class="small">
        <span id="timeText">—</span>
        <span class="mono" id="tipText">提示：首次启动可能稍慢（杀软扫描/载入依赖）。</span>
      </div>
      <div class="small" id="logRow" style="display:none">
        <span class="hint">启动日志</span>
        <a class="mono" id="logLink" href="#" target="_blank" rel="noreferrer">打开</a>
      </div>
    </div>

    <script>
      (function () {
        const params = new URLSearchParams(location.search);
        const host = (params.get("host") || "127.0.0.1").trim() || "127.0.0.1";
        const port = parseInt(params.get("port") || "7860", 10) || 7860;
        const maxTries = Math.max(1, Math.min(50, parseInt(params.get("tries") || "20", 10) || 20));
        const timeoutMs = Math.max(8000, Math.min(600000, parseInt(params.get("timeout_ms") || "180000", 10) || 180000));
        const logUri = (params.get("log") || "").trim();
        const start = Date.now();

        const statusText = document.getElementById("statusText");
        const addrText = document.getElementById("addrText");
        const timeText = document.getElementById("timeText");
        const tipText = document.getElementById("tipText");
        const barInner = document.getElementById("barInner");
        const logRow = document.getElementById("logRow");
        const logLink = document.getElementById("logLink");

        if (logUri) {
          logRow.style.display = "flex";
          logLink.href = logUri;
        }

        const addrs = [];
        for (let i = 0; i < maxTries; i++) addrs.push({ host, port: port + i });

        function fmtMs(ms) {
          const s = Math.max(0, Math.floor(ms / 1000));
          if (s < 60) return `${s}s`;
          return `${Math.floor(s / 60)}m${String(s % 60).padStart(2, "0")}s`;
        }

        let pct = 0;
        const tick = window.setInterval(() => {
          const elapsed = Date.now() - start;
          timeText.textContent = `启动耗时：${fmtMs(elapsed)}`;
          pct = Math.min(92, pct + 1.2);
          barInner.style.width = `${Math.floor(pct)}%`;
        }, 160);

        // NOTE: This page is opened via file:// (pythonw launch). Fetch would be blocked by CORS (Origin: null).
        // Use an <img> probe instead (no CORS) to detect whether the local server is up.
        function probe(h, p) {
          return new Promise((resolve) => {
            const img = new Image();
            let done = false;
            const timer = window.setTimeout(() => finish(false), 650);

            function finish(ok) {
              if (done) return;
              done = true;
              window.clearTimeout(timer);
              try {
                img.onload = null;
                img.onerror = null;
              } catch {}
              resolve(!!ok);
            }

            img.onload = () => finish(true);
            img.onerror = () => finish(false);
            img.referrerPolicy = "no-referrer";
            img.src = `http://${h}:${p}/static/favicon.svg?ts=${Date.now()}`;
          });
        }

        async function loop() {
          const deadline = start + timeoutMs;
          while (Date.now() < deadline) {
            for (const a of addrs) {
              addrText.textContent = `${a.host}:${a.port}`;
              statusText.textContent = `正在连接本地服务 ${a.host}:${a.port} …`;
              if (await probe(a.host, a.port)) {
                window.clearInterval(tick);
                barInner.style.width = "100%";
                statusText.textContent = "已启动，正在打开…";
                tipText.textContent = "如果浏览器提示不安全/被拦截，请放行本地访问（127.0.0.1）。";
                const url = `http://${a.host}:${a.port}/`;
                window.setTimeout(() => (location.href = url), 350);
                return;
              }
            }
            await new Promise((r) => setTimeout(r, 350));
          }
          window.clearInterval(tick);
          barInner.style.width = "100%";
          statusText.textContent = "启动超时：可能被防火墙/杀软拦截，或端口被占用。";
          tipText.textContent = "可尝试：重新运行 TopHumanWriting.vbs；或用 run_web.bat 查看报错；或打开启动日志。";
        }

        loop();
      })();
    </script>
  </body>
</html>
